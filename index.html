<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>jsMind 思维导图示例</title>
    <!-- 引入本地样式文件 -->
    <link type="text/css" rel="stylesheet" href="./style/jsmind.css">
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .mindmap-container {
            flex: 3; /* 思维导图占3份宽度 */
        }
        #jsmind_container {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            background: #f4f4f4;
            border-radius: 4px;
        }
        .node-info-container {
            flex: 1; /* 信息面板占1份宽度 */
            min-width: 300px; /* 最小宽度，确保内容不被挤压 */
        }
        .controls {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        button {
            padding: 6px 12px;
            margin-right: 8px;
            cursor: pointer;
        }
        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            opacity: 0;
            cursor: pointer;
        }
        /* 节点信息面板样式 */
        .node-info-panel {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            height: 600px; /* 与思维导图高度一致 */
            box-sizing: border-box; /* 包含内边距和边框在高度内 */
            overflow-y: auto; /* 内容过多时可滚动 */
        }
        .node-info-panel h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .info-item {
            margin: 12px 0;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            display: block;
            margin-bottom: 4px;
        }
        /* 链接列表样式 */
        .link-list {
            margin: 5px 0 0 20px;
            padding: 0;
        }
        .link-list li {
            margin: 5px 0;
        }
        .link-list a {
            color: #0066cc;
            text-decoration: none;
        }
        .link-list a:hover {
            text-decoration: underline;
        }
        .empty-state {
            color: #999;
            text-align: center;
            padding: 50px 0;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>jsMind 基础示例</h1>
        <div class="controls">
            <button onclick="addNewNode()">添加节点</button>
            <button onclick="changeTheme()">切换主题</button>
            <button onclick="toggleEditMode()">切换编辑模式</button>
            <!-- 获取选中节点按钮 -->
            <button onclick="getSelectedNodeInfo()">获取选中节点</button>
            <div class="file-input-wrapper">
                <button>打开JSON文件</button>
                <input type="file" id="jsonFileInput" accept=".json" onchange="loadJsonFile(this)" />
            </div>
        </div>
        
        <!-- 主内容区：左侧思维导图，右侧信息面板 -->
        <div class="main-content">
            <div class="mindmap-container">
                <div id="jsmind_container"></div>
            </div>
            
            <div class="node-info-container">
                <!-- 节点信息展示面板 -->
                <div class="node-info-panel" id="nodeInfoPanel">
                    <div class="empty-state" id="emptyState">
                        <p>请选择一个节点，然后点击"获取选中节点"按钮查看信息</p>
                    </div>
                    <div id="nodeInfoContent" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入本地JS文件 -->
    <script src="./es6/jsmind.js"></script>
    <script src="./es6/jsmind.draggable-node.js"></script>
    <script>
        // 全局思维导图实例
        let jm = null;
        // 当前主题
        let currentTheme = 'primary';

        // 初始化思维导图
        function initJsMind() {
            // 思维导图数据
            const mindData = {
                meta: {
                    name: '示例思维导图',
                    author: 'jsMind',
                    version: '1.0'
                },
                format: 'node_array',
                 data: [
                    { id: 'root', isroot: true, topic: '中心主题<a>www.baidu.com</a>' },
                    { id: 'sub1', parentid: 'root', topic: '子主题1', 'background-color': '#0066cc' },
                    // 叶子节点：sub11（无子节点）
                    { id: 'sub11', parentid: 'sub1', topic: '子主题1-1', 'link': 'https://example.com/sub11;https://example.com/sub12;' },
                    // 叶子节点：sub12（无子节点）
                    { id: 'sub12', parentid: 'sub1', topic: '子主题1-2', 'link': 'https://example.com/sub12' },
                    { id: 'sub2', parentid: 'root', topic: '子主题2' },
                    // 叶子节点：sub21（无子节点）
                    { id: 'sub21', parentid: 'sub2', topic: '子主题2-1', 'link': 'https://example.com/sub21' },
                    // 叶子节点：sub22（无子节点）
                    { id: 'sub22', parentid: 'sub2', topic: '子主题2-2', 'foreground-color': '#00cc66', 'link': 'https://example.com/sub22' },
                    // 叶子节点：sub3（无子节点）
                    { id: 'sub3', parentid: 'root', topic: '子主题3', 'link': 'https://example.com/sub3' }
                ]
            };

            // 配置选项
            const options = {
                container: 'jsmind_container',
                editable: true,
                theme: currentTheme,
                view: {
                    draggable: true,  // 允许拖拽
                    zoom: {
                        enabled: true  // 允许缩放
                    }
                }
            };

            // 创建实例并显示
            jm = new jsMind(options);
            jm.show(mindData);

            // 初始操作：添加一个新节点并修改颜色
            jm.add_node('sub2', 'sub23', '新增节点', { 'background-color': 'red' });
            jm.set_node_color('sub21', 'green', '#f0f0f0');
        }

        // 添加新节点
        function addNewNode() {
            if (!jm) return;
            const parentId = 'sub3';
            const newNodeId = 'sub3' + Date.now().toString().slice(-4);
            jm.add_node(parentId, newNodeId, '新节点', { 'background-color': '#cc6600' });
        }

        // 切换主题
        function changeTheme() {
            if (!jm) return;
            const themes = ['primary', 'warning', 'danger', 'success', 'greensea', 'wisteria'];
            currentTheme = themes[(themes.indexOf(currentTheme) + 1) % themes.length];
            jm.set_theme(currentTheme);
        }

        // 切换编辑模式
        function toggleEditMode() {
            if (!jm) return;
            const isEditable = jm.get_editable();
            if (isEditable) {
                jm.disable_edit();
                alert('已切换到只读模式');
            } else {
                jm.enable_edit();
                alert('已切换到编辑模式');
            }
        }

        // 获取选中节点信息
        function getSelectedNodeInfo() {
            if (!jm) {
                alert('请先等待思维导图初始化完成');
                return;
            }
            
            const selectedNode = jm.get_selected_node();
            const panel = document.getElementById('nodeInfoPanel');
            const content = document.getElementById('nodeInfoContent');
            const emptyState = document.getElementById('emptyState');
            
            if (selectedNode) {
                // 隐藏空状态，显示内容
                emptyState.style.display = 'none';
                content.style.display = 'block';
                
                // 构建节点信息HTML
                let infoHtml = `
                    <h3>节点信息</h3>
                    <div class="info-item">
                        <span class="info-label">ID:</span> ${selectedNode.id}
                    </div>
                    <div class="info-item">
                        <span class="info-label">主题:</span> ${selectedNode.topic}
                    </div>
                    <div class="info-item">
                        <span class="info-label">父节点ID:</span> ${selectedNode.parentid || '无（根节点）'}
                    </div>
                    <div class="info-item">
                        <span class="info-label">是否为根节点:</span> ${selectedNode.isroot ? '是' : '否'}
                    </div>
                `;
                
                // 处理并展示链接信息（支持多个链接拆分）
                if (selectedNode.data && selectedNode.data.link) {
                    // 去除链接末尾可能的分号，再按分号拆分
                    const links = selectedNode.data.link.replace(/;$/, '').split(';');
                    
                    infoHtml += `
                        <div class="info-item">
                            <span class="info-label">链接:</span>
                            <ul class="link-list">
                    `;
                    
                    // 逐个添加链接，支持点击访问
                    links.forEach(link => {
                        if (link.trim()) {  // 忽略空链接
                            infoHtml += `<li><a href="${link}" target="_blank">${link}</a></li>`;
                        }
                    });
                    
                    infoHtml += `
                            </ul>
                        </div>
                    `;
                }
                
                // 添加颜色信息（如果有）
                if (selectedNode['background-color']) {
                    infoHtml += `
                        <div class="info-item">
                            <span class="info-label">背景色:</span> ${selectedNode['background-color']}
                        </div>
                    `;
                }
                if (selectedNode['foreground-color']) {
                    infoHtml += `
                        <div class="info-item">
                            <span class="info-label">前景色:</span> ${selectedNode['foreground-color']}
                        </div>
                    `;
                }
                
                content.innerHTML = infoHtml;
            } else {
                // 显示空状态提示
                emptyState.style.display = 'flex';
                content.style.display = 'none';
                content.innerHTML = '';
            }
        }

        // 加载JSON文件
        function loadJsonFile(input) {
            if (!jm) {
                alert('请先等待思维导图初始化完成');
                return;
            }

            const file = input.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.name.endsWith('.json')) {
                alert('请选择JSON格式的文件');
                input.value = ''; // 清空选择
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 解析JSON数据
                    const mindData = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (!mindData.format || !mindData.data) {
                        throw new Error('JSON文件格式不正确，缺少必要字段');
                    }

                    // 显示加载的思维导图
                    jm.show(mindData);
                    alert(`成功加载思维导图: ${mindData.meta?.name || '未知名称'}`);
                } catch (error) {
                    console.error('加载JSON文件失败:', error);
                    alert(`加载失败: ${error.message}`);
                }
            };
            
            reader.onerror = function() {
                alert('文件读取失败，请重试');
            };

            reader.readAsText(file);
            // 清空选择，允许重复选择同一文件
            input.value = '';
        }

        // 页面加载完成后初始化
        window.onload = initJsMind;
    </script>
</body>
</html>